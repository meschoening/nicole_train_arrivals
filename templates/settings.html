{% extends "_layout.html" %}
{% set page_title = "Display Settings" %}
{% set page_subtitle = "Tune the arrivals display, timing, and behavior." %}
{% set active_page = "settings" %}

{% block content %}
<form method="post" action="/settings" id="settingsForm" class="content-grid">
  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

  <div class="card">
    <div class="card-title">Route selection</div>
    <div class="field">
      <div class="field-label">
        <strong>Line</strong>
        <span class="field-hint">Choose the primary WMATA line.</span>
      </div>
      <div class="field-control">
        <select id="selected_line" name="selected_line">
          {% for line in lines %}
          <option value="{{ line.line_code }}" {% if config.get('selected_line')==line.line_code %}selected{% endif %}>
            {{ line.display_name }}
          </option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="field">
      <div class="field-label">
        <strong>Station</strong>
        <span class="field-hint">The stop to monitor for arrivals.</span>
      </div>
      <div class="field-control">
        <select id="selected_station" name="selected_station">
          {% for st in stations %}
          <option value="{{ st.code }}" {% if config.get('selected_station')==st.code %}selected{% endif %}>
            {{ st.name }}
          </option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="field">
      <div class="field-label">
        <strong>Destination</strong>
        <span class="field-hint">Filter arrivals by destination.</span>
      </div>
      <div class="field-control">
        <select id="selected_destination" name="selected_destination">
          {% set emoji_map = {'RD':'ðŸ”´','OR':'ðŸŸ ','YL':'ðŸŸ¡','GR':'ðŸŸ¢','BL':'ðŸ”µ','SV':'âš«'} %}
          {% for d in directions %}
          {% if d is mapping %}
          {% set name = d.name %}
          {% set lines = d.lines or [] %}
          {% set ns = namespace(emoji='') %}
          {% for code in lines %}
          {% set ns.emoji = ns.emoji + (emoji_map.get(code, 'âšª')) %}
          {% endfor %}
          <option value="{{ name }}" {% if config.get('selected_destination')==name %}selected{% endif %}>
            {{ (ns.emoji ~ ' ') if ns.emoji else '' }}{{ name }}
          </option>
          {% else %}
          <option value="{{ d }}" {% if config.get('selected_destination')==d %}selected{% endif %}>{{ d }}</option>
          {% endif %}
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Refresh & filtering</div>
    <div class="field">
      <div class="field-label">
        <strong>Refresh rate</strong>
        <span class="field-hint">How often to refresh arrivals (5-120 seconds).</span>
      </div>
      <div class="field-control">
        <input class="input mono" type="number" min="5" max="120" step="1" id="refresh_rate_seconds"
          name="refresh_rate_seconds" value="{{ config.get('refresh_rate_seconds', 30) }}">
        <span class="field-hint">seconds</span>
      </div>
    </div>

    <div class="field">
      <div class="field-label">
        <strong>Show time to refresh</strong>
        <span class="field-hint">Countdown until the next update.</span>
      </div>
      <div class="field-control">
        <label class="toggle">
          <input type="checkbox" name="show_countdown" {% if config.get('show_countdown', True) %}checked{% endif %}>
          <span class="toggle-ui"></span>
        </label>
      </div>
    </div>

    <div class="field">
      <div class="field-label">
        <strong>Show clock in top bar</strong>
        <span class="field-hint">Display the local time on-screen.</span>
      </div>
      <div class="field-control">
        <label class="toggle">
          <input type="checkbox" name="show_clock" {% if config.get('show_clock', True) %}checked{% endif %}>
          <span class="toggle-ui"></span>
        </label>
      </div>
    </div>

    <div class="field">
      <div class="field-label">
        <strong>Filter by selected destination</strong>
        <span class="field-hint">Show only trains matching the destination.</span>
      </div>
      <div class="field-control">
        <label class="toggle">
          <input type="checkbox" name="filter_by_direction" {% if config.get('filter_by_direction', False) %}checked{% endif %}>
          <span class="toggle-ui"></span>
        </label>
      </div>
    </div>

    <div class="field">
      <div class="field-label">
        <strong>Filter by destination direction</strong>
        <span class="field-hint">Only show trains going in a selected direction.</span>
      </div>
      <div class="field-control">
        <label class="toggle">
          <input type="checkbox" name="filter_by_destination_direction"
            {% if config.get('filter_by_destination_direction', False) %}checked{% endif %}>
          <span class="toggle-ui"></span>
        </label>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Display copy & timezone</div>
    <div class="field">
      <div class="field-label">
        <strong>Title text</strong>
        <span class="field-hint">Displayed at the top of the screen.</span>
      </div>
      <div class="field-control">
        <input class="input" type="text" id="title_text" name="title_text"
          value="{{ config.get('title_text', " Nicole's Train Tracker!") }}">
      </div>
    </div>

    <div class="field">
      <div class="field-label">
        <strong>Timezone</strong>
        <span class="field-hint">Clock and schedule timing.</span>
      </div>
      <div class="field-control">
        <select id="timezone" name="timezone">
          {% for tz in timezones %}
          <option value="{{ tz }}" {% if current_timezone==tz %}selected{% endif %}>{{ tz }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Sleep & network</div>
    <div class="field">
      <div class="field-label">
        <strong>Enable screen sleep</strong>
        <span class="field-hint">Allow the display to sleep after inactivity.</span>
      </div>
      <div class="field-control">
        <label class="toggle">
          <input type="checkbox" name="screen_sleep_enabled"
            {% if config.get('screen_sleep_enabled', False) %}checked{% endif %}>
          <span class="toggle-ui"></span>
        </label>
      </div>
    </div>

    <div class="field">
      <div class="field-label">
        <strong>Screen sleep timeout</strong>
        <span class="field-hint">Minutes before sleep (0-240).</span>
      </div>
      <div class="field-control">
        <input class="input mono" type="number" min="0" max="240" step="1" name="screen_sleep_minutes"
          value="{{ config.get('screen_sleep_minutes', 5) }}">
      </div>
    </div>

    <div class="field">
      <div class="field-label">
        <strong>Universal network timeout</strong>
        <span class="field-hint">Max seconds for API requests (1-15).</span>
      </div>
      <div class="field-control">
        <input class="input mono" type="number" min="1" max="15" step="1" id="api_timeout_seconds" name="api_timeout_seconds"
          value="{{ config.get('api_timeout_seconds', 5) }}">
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Save changes</div>
    <div class="field">
      <div class="field-label">
        <strong>Status</strong>
        <span class="field-hint">Updated on {{ last_saved }}</span>
      </div>
      <div class="field-control">
        <span id="lastSaved" class="field-hint">Last saved: {{ last_saved }}</span>
      </div>
    </div>
    <div class="field">
      <div class="field-label">
        <strong>Apply settings</strong>
        <span class="field-hint">Save updates to the display.</span>
      </div>
      <div class="field-control">
        <button class="button button-primary" type="submit">Save settings</button>
      </div>
    </div>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script>
  const lineSel = document.getElementById('selected_line');
  const stationSel = document.getElementById('selected_station');
  const destSel = document.getElementById('selected_destination');

  async function loadStations(lineCode) {
    stationSel.innerHTML = '';
    destSel.innerHTML = '';
    if (!lineCode) return;
    const res = await fetch(`/api/stations?line=${encodeURIComponent(lineCode)}`);
    const stations = await res.json();
    for (const st of stations) {
      const opt = document.createElement('option');
      opt.value = st.code;
      opt.textContent = st.name;
      stationSel.appendChild(opt);
    }
    if (stationSel.value) {
      await loadDirections(stationSel.value);
    }
  }

  const lineEmoji = { RD: 'ðŸ”´', OR: 'ðŸŸ ', YL: 'ðŸŸ¡', GR: 'ðŸŸ¢', BL: 'ðŸ”µ', SV: 'âš«' };

  async function loadDirections(stationCode) {
    destSel.innerHTML = '';
    if (!stationCode) return;
    const res = await fetch(`/api/directions?station=${encodeURIComponent(stationCode)}`);
    const dirs = await res.json();
    for (const d of dirs) {
      let name;
      let lines;
      if (typeof d === 'string') {
        name = d;
        lines = [];
      } else {
        name = d.name;
        lines = Array.isArray(d.lines) ? d.lines : [];
      }
      const emoji = lines.map(code => lineEmoji[code] || 'âšª').join('');
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = (emoji ? emoji + ' ' : '') + name;
      destSel.appendChild(opt);
    }
  }

  lineSel.addEventListener('change', () => loadStations(lineSel.value));
  stationSel.addEventListener('change', () => loadDirections(stationSel.value));

  const settingsForm = document.getElementById('settingsForm');
  const lastSaved = document.getElementById('lastSaved');
  function markUnsaved() {
    if (lastSaved) lastSaved.style.color = 'var(--danger)';
  }
  settingsForm.addEventListener('change', markUnsaved);

  const filterByDestCheckbox = document.querySelector('input[name="filter_by_direction"]');
  const filterByDirCheckbox = document.querySelector('input[name="filter_by_destination_direction"]');

  if (filterByDestCheckbox && filterByDirCheckbox) {
    filterByDestCheckbox.addEventListener('change', function () {
      if (this.checked && filterByDirCheckbox.checked) {
        filterByDirCheckbox.checked = false;
      }
    });

    filterByDirCheckbox.addEventListener('change', function () {
      if (this.checked && filterByDestCheckbox.checked) {
        filterByDestCheckbox.checked = false;
      }
    });
  }
</script>
{% endblock %}
