{% extends "_layout.html" %}
{% set page_title = "Title Messages" %}
{% set page_subtitle = "Curate on-screen message rotation and timing." %}
{% set active_page = "messages" %}

{% block head_extra %}
<style>
  .message-list {
    min-height: 220px;
    max-height: 360px;
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px;
    margin-bottom: 12px;
    background: var(--surface-muted);
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .message-item,
  .message-edit-row {
    background: var(--surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-sm);
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
  }

  .message-item.selected {
    border-color: var(--accent);
    background: var(--accent-weak);
    color: var(--accent);
  }

  .message-text {
    flex: 1;
    font-size: 13px;
    color: var(--text);
  }

  .color-swatch {
    width: 24px;
    height: 24px;
    border-radius: 8px;
    border: 1px dashed var(--border);
    flex-shrink: 0;
  }

  .message-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .message-edit-row {
    flex-direction: column;
    align-items: stretch;
    cursor: default;
  }

  .message-edit-controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
  }

  .trigger-active {
    background: rgba(192, 55, 43, 0.15);
    border-color: rgba(192, 55, 43, 0.4);
    color: var(--danger);
  }
</style>
{% endblock %}

{% block content %}
<form id="messagesForm" class="content-grid">
  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

  <div class="split-grid">
    <div class="card">
      <div class="card-title">Custom messages</div>
      <div class="card-subtitle">Click a message to select, or edit to adjust text and color.</div>
      <div class="message-list" id="messageList"></div>
      <div class="message-actions">
        <button type="button" class="button" id="addMessageBtn">Add new message</button>
        <button type="button" class="button button-danger" id="deleteMessageBtn">Delete selected</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Display timing</div>
      <div class="field">
        <div class="field-label">
          <strong>Timing mode</strong>
          <span class="field-hint">Pick how messages should appear.</span>
        </div>
        <div class="field-control pill-group">
          <label class="radio-pill">
            <input type="radio" name="timing_mode" value="periodic" id="timingPeriodic">
            <span>Periodic</span>
          </label>
          <label class="radio-pill">
            <input type="radio" name="timing_mode" value="random" id="timingRandom">
            <span>Random</span>
          </label>
          <label class="radio-pill">
            <input type="radio" name="timing_mode" value="disabled" id="timingDisabled">
            <span>Disabled</span>
          </label>
        </div>
      </div>

      <div class="stack" id="periodicSettings">
        <div class="field">
          <div class="field-label">
            <strong>Show every</strong>
            <span class="field-hint">Minutes between messages.</span>
          </div>
          <div class="field-control">
            <input class="input mono" type="number" id="periodicInterval" name="periodic_interval_minutes" min="1"
              max="1440" step="1" value="30">
          </div>
        </div>
        <div class="field">
          <div class="field-label">
            <strong>Time window</strong>
            <span class="field-hint">Only show within a daily window.</span>
          </div>
          <div class="field-control">
            <label class="toggle">
              <input type="checkbox" id="periodicTimeWindow" name="periodic_time_window_enabled">
              <span class="toggle-ui"></span>
            </label>
          </div>
        </div>
        <div class="stack" id="periodicTimeWindowSettings" style="display: none;">
          <div class="field">
            <div class="field-label">
              <strong>Window start</strong>
            </div>
            <div class="field-control">
              <input class="input mono" type="text" id="periodicWindowStart" name="periodic_window_start"
                placeholder="09:00">
            </div>
          </div>
          <div class="field">
            <div class="field-label">
              <strong>Window end</strong>
            </div>
            <div class="field-control">
              <input class="input mono" type="text" id="periodicWindowEnd" name="periodic_window_end"
                placeholder="17:00">
            </div>
          </div>
        </div>
      </div>

      <div class="stack" id="randomSettings" style="display: none;">
        <div class="field">
          <div class="field-label">
            <strong>Minimum minutes</strong>
          </div>
          <div class="field-control">
            <input class="input mono" type="number" id="randomMin" name="random_min_minutes" min="1" max="1440" step="1"
              value="15">
          </div>
        </div>
        <div class="field">
          <div class="field-label">
            <strong>Maximum minutes</strong>
          </div>
          <div class="field-control">
            <input class="input mono" type="number" id="randomMax" name="random_max_minutes" min="1" max="1440" step="1"
              value="60">
          </div>
        </div>
        <div class="field">
          <div class="field-label">
            <strong>Time window</strong>
            <span class="field-hint">Only show within a daily window.</span>
          </div>
          <div class="field-control">
            <label class="toggle">
              <input type="checkbox" id="randomTimeWindow" name="random_time_window_enabled">
              <span class="toggle-ui"></span>
            </label>
          </div>
        </div>
        <div class="stack" id="randomTimeWindowSettings" style="display: none;">
          <div class="field">
            <div class="field-label">
              <strong>Window start</strong>
            </div>
            <div class="field-control">
              <input class="input mono" type="text" id="randomWindowStart" name="random_window_start"
                placeholder="09:00">
            </div>
          </div>
          <div class="field">
            <div class="field-label">
              <strong>Window end</strong>
            </div>
            <div class="field-control">
              <input class="input mono" type="text" id="randomWindowEnd" name="random_window_end"
                placeholder="17:00">
            </div>
          </div>
        </div>
      </div>

      <div class="field">
        <div class="field-label">
          <strong>Message duration</strong>
          <span class="field-hint">Seconds each message stays on screen.</span>
        </div>
        <div class="field-control">
          <input class="input mono" type="number" id="displayDuration" name="display_duration_seconds" min="1" max="60"
            step="1" value="5">
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Live trigger</div>
    <div class="field">
      <div class="field-label">
        <strong>Trigger message now</strong>
        <span class="field-hint">Shows the selected message, or a random one.</span>
      </div>
      <div class="field-control">
        <button type="button" class="button" id="triggerNowBtn">Trigger message now</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Save changes</div>
    <div class="field">
      <div class="field-label">
        <strong>Status</strong>
        <span class="field-hint">Changes are only saved when you click save.</span>
      </div>
      <div class="field-control">
        <span id="lastSaved" class="field-hint">Last saved: {{ last_saved }}</span>
      </div>
    </div>
    <div class="field">
      <div class="field-label">
        <strong>Apply settings</strong>
        <span class="field-hint">Send updated messages to the display.</span>
      </div>
      <div class="field-control">
        <button type="submit" class="button button-primary">Save settings</button>
      </div>
    </div>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script>
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  function hexToRgb(hex) {
    if (!hex) return null;
    hex = hex.trim().replace('#', '');
    if (hex.length !== 6) return null;
    const r = parseInt(hex.substring(0, 2), 16);
    const g = parseInt(hex.substring(2, 4), 16);
    const b = parseInt(hex.substring(4, 6), 16);
    if (Number.isNaN(r) || Number.isNaN(g) || Number.isNaN(b)) return null;
    return `rgb(${r}, ${g}, ${b})`;
  }

  function rgbToHex(rgb) {
    if (!rgb || rgb === 'null' || rgb === 'undefined') return '#000000';
    const match = rgb.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
    if (match) {
      const r = parseInt(match[1]).toString(16).padStart(2, '0');
      const g = parseInt(match[2]).toString(16).padStart(2, '0');
      const b = parseInt(match[3]).toString(16).padStart(2, '0');
      return `#${r}${g}${b}`;
    }
    return '#000000';
  }

  let messagesRaw = JSON.parse({{ messages_json | tojson }});
  let messages = messagesRaw.map(msg => {
    if (typeof msg === 'string') {
      return { text: msg, color: null };
    }
    return {
      text: msg.text || '',
      color: msg.color || null
    };
  });
  let selectedIndex = -1;
  let editingIndex = -1;

  function renderMessages() {
    const listEl = document.getElementById('messageList');
    listEl.innerHTML = '';

    if (messages.length === 0) {
      listEl.innerHTML = '<div class="field-hint" style="text-align:center; padding: 12px;">No messages yet. Click "Add new message" to create one.</div>';
      return;
    }

    messages.forEach((msg, idx) => {
      if (editingIndex === idx) {
        const editRow = document.createElement('div');
        editRow.className = 'message-edit-row';

        const textInput = document.createElement('input');
        textInput.type = 'text';
        textInput.value = msg.text;
        textInput.placeholder = 'Message text';
        textInput.className = 'input';

        const controls = document.createElement('div');
        controls.className = 'message-edit-controls';

        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.backgroundColor = msg.color || 'transparent';

        const colorInput = document.createElement('input');
        colorInput.type = 'text';
        colorInput.value = msg.color ? rgbToHex(msg.color) : '';
        colorInput.placeholder = '#000000';
        colorInput.className = 'input mono';

        const toggleWrap = document.createElement('label');
        toggleWrap.className = 'toggle';
        const useDefaultCheckbox = document.createElement('input');
        useDefaultCheckbox.type = 'checkbox';
        useDefaultCheckbox.checked = !msg.color;
        useDefaultCheckbox.id = 'useDefault_' + idx;
        const toggleUi = document.createElement('span');
        toggleUi.className = 'toggle-ui';
        toggleWrap.appendChild(useDefaultCheckbox);
        toggleWrap.appendChild(toggleUi);

        const useDefaultLabel = document.createElement('span');
        useDefaultLabel.textContent = 'Use default color';
        useDefaultLabel.className = 'field-hint';

        const syncColorState = () => {
          const disabled = useDefaultCheckbox.checked;
          colorInput.disabled = disabled;
          if (disabled) {
            swatch.style.backgroundColor = 'transparent';
          } else {
            const rgbValue = hexToRgb(colorInput.value);
            swatch.style.backgroundColor = rgbValue || 'transparent';
          }
        };

        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'Save';
        saveBtn.className = 'button button-primary';
        saveBtn.type = 'button';
        saveBtn.onclick = () => {
          const newText = textInput.value.trim();
          if (newText) {
            const useDefault = useDefaultCheckbox.checked;
            const rgbValue = useDefault ? null : hexToRgb(colorInput.value);
            if (!useDefault && !rgbValue) {
              alert('Enter a valid hex color like #FFAA00.');
              return;
            }
            messages[idx] = {
              text: newText,
              color: useDefault ? null : rgbValue
            };
            editingIndex = -1;
            renderMessages();
            markUnsaved();
          } else {
            alert('Message text cannot be empty.');
          }
        };

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancel';
        cancelBtn.className = 'button';
        cancelBtn.type = 'button';
        cancelBtn.onclick = () => {
          editingIndex = -1;
          renderMessages();
        };

        colorInput.addEventListener('input', () => {
          const rgbValue = hexToRgb(colorInput.value);
          swatch.style.backgroundColor = rgbValue || 'transparent';
        });
        useDefaultCheckbox.addEventListener('change', syncColorState);
        syncColorState();

        controls.appendChild(swatch);
        controls.appendChild(colorInput);
        controls.appendChild(toggleWrap);
        controls.appendChild(useDefaultLabel);
        controls.appendChild(saveBtn);
        controls.appendChild(cancelBtn);

        editRow.appendChild(textInput);
        editRow.appendChild(controls);
        listEl.appendChild(editRow);
      } else {
        const div = document.createElement('div');
        div.className = 'message-item' + (idx === selectedIndex ? ' selected' : '');

        const colorSwatch = document.createElement('div');
        colorSwatch.className = 'color-swatch';
        if (msg.color) {
          colorSwatch.style.backgroundColor = msg.color;
          colorSwatch.style.border = 'none';
        }

        const textSpan = document.createElement('span');
        textSpan.className = 'message-text';
        textSpan.textContent = msg.text;

        div.appendChild(colorSwatch);
        div.appendChild(textSpan);

        div.onclick = (e) => {
          if (e.target.tagName === 'BUTTON') return;
          selectedIndex = (selectedIndex === idx) ? -1 : idx;
          renderMessages();
        };

        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.className = 'button';
        editBtn.type = 'button';
        editBtn.onclick = (e) => {
          e.stopPropagation();
          editingIndex = idx;
          selectedIndex = -1;
          renderMessages();
        };
        div.appendChild(editBtn);

        listEl.appendChild(div);
      }
    });
  }

  document.getElementById('addMessageBtn').onclick = () => {
    const msg = prompt('Enter new message:');
    if (msg && msg.trim()) {
      messages.push({ text: msg.trim(), color: null });
      editingIndex = messages.length - 1;
      renderMessages();
      markUnsaved();
    }
  };

  document.getElementById('deleteMessageBtn').onclick = () => {
    if (selectedIndex >= 0 && selectedIndex < messages.length) {
      const msgText = messages[selectedIndex].text || messages[selectedIndex];
      if (confirm(`Delete message: "${msgText}"?`)) {
        messages.splice(selectedIndex, 1);
        selectedIndex = -1;
        editingIndex = -1;
        renderMessages();
        markUnsaved();
      }
    } else {
      alert('Please select a message to delete.');
    }
  };

  const periodicRadio = document.getElementById('timingPeriodic');
  const randomRadio = document.getElementById('timingRandom');
  const disabledRadio = document.getElementById('timingDisabled');
  const periodicSettings = document.getElementById('periodicSettings');
  const randomSettings = document.getElementById('randomSettings');

  function updateTimingDisplay() {
    if (periodicRadio.checked) {
      periodicSettings.style.display = 'flex';
      randomSettings.style.display = 'none';
    } else if (randomRadio.checked) {
      periodicSettings.style.display = 'none';
      randomSettings.style.display = 'flex';
    } else {
      periodicSettings.style.display = 'none';
      randomSettings.style.display = 'none';
    }
  }

  periodicRadio.addEventListener('change', updateTimingDisplay);
  randomRadio.addEventListener('change', updateTimingDisplay);
  disabledRadio.addEventListener('change', updateTimingDisplay);

  const periodicTimeWindowCheckbox = document.getElementById('periodicTimeWindow');
  const periodicTimeWindowSettings = document.getElementById('periodicTimeWindowSettings');
  const randomTimeWindowCheckbox = document.getElementById('randomTimeWindow');
  const randomTimeWindowSettings = document.getElementById('randomTimeWindowSettings');

  periodicTimeWindowCheckbox.addEventListener('change', function () {
    periodicTimeWindowSettings.style.display = this.checked ? 'flex' : 'none';
  });

  randomTimeWindowCheckbox.addEventListener('change', function () {
    randomTimeWindowSettings.style.display = this.checked ? 'flex' : 'none';
  });

  let countdownInterval = null;
  const triggerBtn = document.getElementById('triggerNowBtn');
  const originalBtnText = 'Trigger message now';

  triggerBtn.onclick = async () => {
    const message = selectedIndex >= 0 ? messages[selectedIndex] : null;

    try {
      const response = await fetch('/api/trigger_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify({ message: message })
      });

      if (!response.ok) {
        alert('Failed to trigger message.');
        return;
      }

      const config = {{ config | tojson }};
      const displaySeconds = config.display_duration_seconds || 5;
      const fadeDurationMs = config.fade_duration_ms || 800;
      const totalSeconds = displaySeconds + (2 * fadeDurationMs / 1000) + 1;
      startCountdown(Math.ceil(totalSeconds));
    } catch (e) {
      alert('Error triggering message: ' + e.message);
    }
  };

  function startCountdown(seconds) {
    let remaining = seconds;
    triggerBtn.disabled = true;
    triggerBtn.classList.add('trigger-active');
    triggerBtn.textContent = `On screen (${remaining})`;

    countdownInterval = setInterval(() => {
      remaining--;
      if (remaining <= 0) {
        clearInterval(countdownInterval);
        triggerBtn.disabled = false;
        triggerBtn.classList.remove('trigger-active');
        triggerBtn.textContent = originalBtnText;
      } else {
        triggerBtn.textContent = `On screen (${remaining})`;
      }
    }, 1000);
  }

  document.getElementById('messagesForm').onsubmit = async (e) => {
    e.preventDefault();

    const data = {
      messages: messages,
      timing_mode: document.querySelector('input[name="timing_mode"]:checked').value,
      periodic_interval_minutes: parseInt(document.getElementById('periodicInterval').value),
      periodic_time_window_enabled: document.getElementById('periodicTimeWindow').checked,
      periodic_window_start: document.getElementById('periodicWindowStart').value,
      periodic_window_end: document.getElementById('periodicWindowEnd').value,
      random_min_minutes: parseInt(document.getElementById('randomMin').value),
      random_max_minutes: parseInt(document.getElementById('randomMax').value),
      random_time_window_enabled: document.getElementById('randomTimeWindow').checked,
      random_window_start: document.getElementById('randomWindowStart').value,
      random_window_end: document.getElementById('randomWindowEnd').value,
      display_duration_seconds: parseInt(document.getElementById('displayDuration').value),
      fade_duration_ms: {{ config.get('fade_duration_ms', 800) }}
    };

    try {
      const response = await fetch('/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        const result = await response.json();
        document.getElementById('lastSaved').textContent = 'Last saved: ' + result.timestamp;
        document.getElementById('lastSaved').style.color = 'var(--text-muted)';
      } else {
        alert('Failed to save settings.');
      }
    } catch (e) {
      alert('Error saving settings: ' + e.message);
    }
  };

  const lastSaved = document.getElementById('lastSaved');
  function markUnsaved() {
    if (lastSaved) lastSaved.style.color = 'var(--danger)';
  }
  document.getElementById('messagesForm').addEventListener('change', markUnsaved);

  const config = {{ config | tojson }};
  periodicRadio.checked = config.timing_mode === 'periodic';
  randomRadio.checked = config.timing_mode === 'random';
  disabledRadio.checked = config.timing_mode === 'disabled';
  document.getElementById('periodicInterval').value = config.periodic_interval_minutes;
  document.getElementById('periodicTimeWindow').checked = config.periodic_time_window_enabled || false;
  document.getElementById('periodicWindowStart').value = config.periodic_window_start || '09:00';
  document.getElementById('periodicWindowEnd').value = config.periodic_window_end || '17:00';
  document.getElementById('randomMin').value = config.random_min_minutes;
  document.getElementById('randomMax').value = config.random_max_minutes;
  document.getElementById('randomTimeWindow').checked = config.random_time_window_enabled || false;
  document.getElementById('randomWindowStart').value = config.random_window_start || '09:00';
  document.getElementById('randomWindowEnd').value = config.random_window_end || '17:00';
  document.getElementById('displayDuration').value = config.display_duration_seconds;

  periodicTimeWindowSettings.style.display = config.periodic_time_window_enabled ? 'flex' : 'none';
  randomTimeWindowSettings.style.display = config.random_time_window_enabled ? 'flex' : 'none';

  updateTimingDisplay();
  renderMessages();
</script>
{% endblock %}
