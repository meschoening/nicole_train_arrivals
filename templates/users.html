{% extends "_layout.html" %}
{% set page_title = "User Access" %}
{% set page_subtitle = "Manage accounts and passwords for the settings interface." %}
{% set active_page = "users" %}

{% block content %}
<div class="content-grid">
  {% if force_password_change %}
  <div class="notice warning">
    Your account requires a password update. Use the "Change password" form below.
  </div>
  {% endif %}

  {% if error %}
  <div class="notice danger">{{ error }}</div>
  {% endif %}

  {% if message %}
  <div class="notice success">{{ message }}</div>
  {% endif %}

  <div class="card">
    <div class="card-title">Existing users</div>
    <table class="table">
      <thead>
        <tr>
          <th>Username</th>
          <th>Updated</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr>
          <td>
            {{ user.username }}
            {% if current_username == user.username %}
            <span class="badge">Current</span>
            {% endif %}
            {% if user.must_change_password %}
            <span class="badge">Needs update</span>
            {% endif %}
          </td>
          <td>{{ user.updated_at or user.created_at }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="split-grid">
    <div class="card">
      <div class="card-title">Add user</div>
      <form method="post" action="/users/add">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="field">
          <div class="field-label">
            <strong>Username</strong>
          </div>
          <div class="field-control">
            <input type="text" id="new_username" name="username" class="input" required>
          </div>
        </div>
        <div class="field">
          <div class="field-label">
            <strong>Password</strong>
          </div>
          <div class="field-control">
            <input type="password" id="new_password" name="password" class="input" required>
          </div>
        </div>
        <div class="field">
          <div class="field-label">
            <strong>Confirm password</strong>
          </div>
          <div class="field-control">
            <input type="password" id="new_password_confirm" name="confirm_password" class="input" required>
          </div>
        </div>
        <div class="field">
          <div class="field-label">
            <strong>Action</strong>
          </div>
          <div class="field-control">
            <button type="submit" class="button button-primary">Add user</button>
          </div>
        </div>
      </form>
    </div>

    <div class="card">
      <div class="card-title">Change password</div>
      <form method="post" action="/users/password">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="field">
          <div class="field-label">
            <strong>User</strong>
          </div>
          <div class="field-control">
            <select id="change_username" name="username">
              {% for user in users %}
              <option value="{{ user.username }}" {% if current_username==user.username %}selected{% endif %}>
                {{ user.username }}
              </option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="field">
          <div class="field-label">
            <strong>New password</strong>
          </div>
          <div class="field-control">
            <input type="password" id="change_password" name="password" class="input" required>
          </div>
        </div>
        <div class="field">
          <div class="field-label">
            <strong>Confirm password</strong>
          </div>
          <div class="field-control">
            <input type="password" id="change_password_confirm" name="confirm_password" class="input" required>
          </div>
        </div>
        <div class="field">
          <div class="field-label">
            <strong>Action</strong>
          </div>
          <div class="field-control">
            <button type="submit" class="button">Update password</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Remove user</div>
    <form method="post" action="/users/remove">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <div class="field">
        <div class="field-label">
          <strong>User</strong>
          <span class="field-hint">At least one user must remain.</span>
        </div>
        <div class="field-control">
          <select id="remove_username" name="username">
            {% for user in users %}
            <option value="{{ user.username }}">{{ user.username }}</option>
            {% endfor %}
          </select>
          <button type="submit" class="button button-danger" {% if users|length <= 1 %}disabled{% endif %}>Remove
            user</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}
