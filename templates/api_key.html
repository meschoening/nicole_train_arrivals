{% extends "_layout.html" %}
{% set page_title = "Authentication Keys" %}
{% set page_subtitle = "Manage API tokens, SSH keys, and HTTPS certificates." %}
{% set active_page = "api_key" %}

{% block head_extra %}
<style>
  .row {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 12px;
  }

  .ssh-key-display {
    width: 100%;
    min-height: 80px;
    padding: 12px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--surface-muted);
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--text-secondary);
    resize: vertical;
  }

  .status-message {
    margin-top: 12px;
    padding: 12px 16px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--surface-muted);
    font-size: 13px;
  }

  .status-message.success {
    border-color: rgba(31, 122, 93, 0.4);
    background: rgba(31, 122, 93, 0.12);
    color: var(--success);
  }

  .status-message.error {
    border-color: rgba(192, 55, 43, 0.4);
    background: rgba(192, 55, 43, 0.12);
    color: var(--danger);
  }

  .remote-ssh {
    color: var(--success);
    background: rgba(31, 122, 93, 0.12);
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 11px;
  }

  .remote-https {
    color: var(--warning);
    background: rgba(164, 91, 0, 0.12);
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 11px;
  }

  .remote-unknown {
    color: var(--text-muted);
  }

  .regenerate-container {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .regenerate-email-input {
    display: none;
  }

  .regenerate-email-input.visible {
    display: inline-block;
  }

  .confirm-state {
    background: rgba(164, 91, 0, 0.12);
    border-color: rgba(164, 91, 0, 0.4);
    color: var(--warning);
  }

  #sslStatusRows.stack {
    gap: 0;
  }
</style>
{% endblock %}

{% block content %}
<div class="content-grid">
  <div class="card">
    <div class="card-title">Metro API key</div>
    <form method="post" action="/api-key" id="apiKeyForm">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <div class="field">
        <div class="field-label">
          <strong>WMATA API key</strong>
          <span class="field-hint">Used to fetch real-time arrival data.</span>
        </div>
        <div class="field-control">
          <input class="input mono" type="text" id="api_key" name="api_key" value="{{ api_key }}"
            placeholder="Enter your API key">
        </div>
      </div>
      <div class="field">
        <div class="field-label">
          <strong>Status</strong>
          <span class="field-hint">Updated on {{ last_saved }}</span>
        </div>
        <div class="field-control">
          <span id="lastSaved" class="field-hint">Last saved: {{ last_saved }}</span>
          <button type="submit" class="button button-primary">Save key</button>
        </div>
      </div>
    </form>
  </div>

  <div class="card" id="sshKeySection">
    <div class="card-title">Git SSH key</div>
    <div class="card-subtitle">
      Git remote:
      <span id="gitRemoteType"
        class="{% if git_remote_type == 'ssh' %}remote-ssh{% elif git_remote_type == 'https' %}remote-https{% else %}remote-unknown{% endif %}">
        {{ git_remote_type }}
      </span>
    </div>

    {% if ssh_key_exists %}
    <div id="sshKeyExists">
      <div class="row">
        <textarea class="ssh-key-display" id="sshPublicKey" readonly>{{ ssh_public_key }}</textarea>
      </div>
      <div class="row">
        <button type="button" class="button" id="copyKeyBtn" onclick="copySSHKey()">Copy SSH public key</button>
        <span class="regenerate-container">
          <input type="email" id="regenerateEmail" class="input regenerate-email-input" placeholder="your@email.com">
          <button type="button" class="button" id="regenerateKeyBtn" onclick="handleRegenerateClick()">Regenerate SSH
            keypair</button>
        </span>
      </div>
    </div>
    {% else %}
    <div id="sshKeyGenerate">
      <div class="field">
        <div class="field-label">
          <strong>Email</strong>
          <span class="field-hint">Used for the SSH key comment.</span>
        </div>
        <div class="field-control">
          <input type="email" id="sshEmail" class="input" placeholder="your@email.com">
        </div>
      </div>
      <div class="row">
        <button type="button" class="button" id="generateKeyBtn" onclick="generateSSHKey()">Generate SSH keys</button>
      </div>
    </div>
    {% endif %}

    <div id="sshStatusMessage"></div>
  </div>

  <div class="card" id="sslSection">
    <div class="card-title">SSL (HTTPS) certificate</div>
    {% if not ssl_status.tailscale_installed %}
    <div class="notice danger">
      Tailscale is not installed and is required for HTTPS setup.
    </div>
    {% else %}
    <div id="sslStatusRows" class="stack">
      <div class="field">
        <div class="field-label">
          <strong>Certificate (.crt)</strong>
        </div>
        <div class="field-control">
          <span class="field-hint">
            {% if ssl_status.cert_found %}✓ Found{% else %}✗ Not found{% endif %}
          </span>
        </div>
      </div>
      <div class="field">
        <div class="field-label">
          <strong>Private key (.key)</strong>
        </div>
        <div class="field-control">
          <span class="field-hint">
            {% if ssl_status.key_found %}✓ Found{% else %}✗ Not found{% endif %}
          </span>
        </div>
      </div>
    </div>
    <div class="row">
      <button type="button" class="button" id="generateSslBtn" onclick="generateSslCert()">
        {% if ssl_status.cert_found and ssl_status.key_found %}
        Regenerate SSL certificates
        {% else %}
        Generate SSL certificates
        {% endif %}
      </button>
    </div>
    <div id="sslStatusMessage"></div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  const apiKeyForm = document.getElementById('apiKeyForm');
  const lastSaved = document.getElementById('lastSaved');
  function markUnsaved() {
    if (lastSaved) lastSaved.style.color = 'var(--danger)';
  }
  apiKeyForm.addEventListener('change', markUnsaved);
  apiKeyForm.addEventListener('input', markUnsaved);

  function showStatus(message, isError) {
    const statusEl = document.getElementById('sshStatusMessage');
    statusEl.className = 'status-message ' + (isError ? 'error' : 'success');
    statusEl.textContent = message;
    statusEl.style.display = 'block';
  }

  async function generateSSHKey() {
    const emailInput = document.getElementById('sshEmail');
    const generateBtn = document.getElementById('generateKeyBtn');
    const email = emailInput.value.trim();

    if (!email) {
      showStatus('Please enter an email address.', true);
      return;
    }

    if (!/^[\w.+-]+@[\w.-]+\.[a-zA-Z]{2,}$/.test(email)) {
      showStatus('Please enter a valid email address.', true);
      return;
    }

    generateBtn.disabled = true;
    generateBtn.textContent = 'Generating...';

    try {
      const response = await fetch('/api/generate-ssh-key', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify({ email: email })
      });

      const data = await response.json();

      if (data.success) {
        showStatus('SSH keys generated successfully!', false);
        const generateDiv = document.getElementById('sshKeyGenerate');

        const existsDiv = document.createElement('div');
        existsDiv.id = 'sshKeyExists';

        const row1 = document.createElement('div');
        row1.className = 'row';
        const textarea = document.createElement('textarea');
        textarea.className = 'ssh-key-display';
        textarea.id = 'sshPublicKey';
        textarea.readOnly = true;
        textarea.textContent = data.public_key;
        row1.appendChild(textarea);

        const row2 = document.createElement('div');
        row2.className = 'row';
        const copyBtn = document.createElement('button');
        copyBtn.type = 'button';
        copyBtn.id = 'copyKeyBtn';
        copyBtn.textContent = 'Copy SSH public key';
        copyBtn.className = 'button';
        copyBtn.onclick = copySSHKey;
        row2.appendChild(copyBtn);

        const regenerateContainer = document.createElement('span');
        regenerateContainer.className = 'regenerate-container';

        const regenerateEmailInput = document.createElement('input');
        regenerateEmailInput.type = 'email';
        regenerateEmailInput.id = 'regenerateEmail';
        regenerateEmailInput.className = 'input regenerate-email-input';
        regenerateEmailInput.placeholder = 'your@email.com';
        regenerateContainer.appendChild(regenerateEmailInput);

        const regenerateBtn = document.createElement('button');
        regenerateBtn.type = 'button';
        regenerateBtn.id = 'regenerateKeyBtn';
        regenerateBtn.textContent = 'Regenerate SSH keypair';
        regenerateBtn.className = 'button';
        regenerateBtn.onclick = handleRegenerateClick;
        regenerateContainer.appendChild(regenerateBtn);

        row2.appendChild(regenerateContainer);

        existsDiv.appendChild(row1);
        existsDiv.appendChild(row2);

        generateDiv.replaceWith(existsDiv);

        if (data.remote_type) {
          const remoteTypeSpan = document.getElementById('gitRemoteType');
          if (remoteTypeSpan) {
            remoteTypeSpan.textContent = data.remote_type.toUpperCase();
            remoteTypeSpan.classList.remove('remote-ssh', 'remote-https', 'remote-unknown');
            remoteTypeSpan.classList.add('remote-' + data.remote_type);
          }
          if (data.remote_converted) {
            showStatus('SSH keys generated and git remote converted to SSH!', false);
          }
        }
      } else {
        showStatus('Error: ' + data.error, true);
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate SSH keys';
      }
    } catch (error) {
      showStatus('Error: ' + error.message, true);
      generateBtn.disabled = false;
      generateBtn.textContent = 'Generate SSH keys';
    }
  }

  async function copySSHKey() {
    const keyTextarea = document.getElementById('sshPublicKey');
    const copyBtn = document.getElementById('copyKeyBtn');
    const keyText = keyTextarea.value;

    try {
      await navigator.clipboard.writeText(keyText);
      copyBtn.textContent = 'Copied!';
      showStatus('SSH public key copied to clipboard!', false);
      setTimeout(() => {
        copyBtn.textContent = 'Copy SSH public key';
      }, 2000);
    } catch (error) {
      keyTextarea.select();
      keyTextarea.setSelectionRange(0, 99999);
      showStatus('Press Ctrl+C to copy the selected key.', false);
    }
  }

  let regenerateConfirmState = false;
  let regenerateTimeout = null;

  function extractEmailFromPublicKey() {
    const keyTextarea = document.getElementById('sshPublicKey');
    if (!keyTextarea) return '';
    const keyText = keyTextarea.value || '';
    const parts = keyText.trim().split(' ');
    if (parts.length >= 3) {
      const email = parts[parts.length - 1];
      if (/^[\w.+-]+@[\w.-]+\.[a-zA-Z]{2,}$/.test(email)) {
        return email;
      }
    }
    return '';
  }

  function resetRegenerateState() {
    regenerateConfirmState = false;
    const regenerateBtn = document.getElementById('regenerateKeyBtn');
    const emailInput = document.getElementById('regenerateEmail');
    if (regenerateBtn) {
      regenerateBtn.textContent = 'Regenerate SSH keypair';
      regenerateBtn.classList.remove('confirm-state');
    }
    if (emailInput) {
      emailInput.classList.remove('visible');
    }
    if (regenerateTimeout) {
      clearTimeout(regenerateTimeout);
      regenerateTimeout = null;
    }
  }

  function handleRegenerateClick() {
    const regenerateBtn = document.getElementById('regenerateKeyBtn');
    const emailInput = document.getElementById('regenerateEmail');

    if (!regenerateConfirmState) {
      regenerateConfirmState = true;
      regenerateBtn.textContent = 'Confirm regenerate?';
      regenerateBtn.classList.add('confirm-state');
      emailInput.classList.add('visible');
      const existingEmail = extractEmailFromPublicKey();
      if (existingEmail) {
        emailInput.value = existingEmail;
      }
      emailInput.focus();

      regenerateTimeout = setTimeout(() => {
        resetRegenerateState();
      }, 8000);
      return;
    }

    const email = emailInput.value.trim();
    if (!email) {
      showStatus('Please enter an email address.', true);
      return;
    }

    regenerateBtn.disabled = true;
    regenerateBtn.textContent = 'Regenerating...';

    fetch('/api/regenerate-ssh-key', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
      body: JSON.stringify({ email: email })
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          const keyTextarea = document.getElementById('sshPublicKey');
          if (keyTextarea) {
            keyTextarea.textContent = data.public_key;
          }
          showStatus('SSH keypair regenerated.', false);
        } else {
          showStatus('Error: ' + data.error, true);
        }
        regenerateBtn.disabled = false;
        regenerateBtn.textContent = 'Regenerate SSH keypair';
        resetRegenerateState();
      })
      .catch((error) => {
        showStatus('Error: ' + error.message, true);
        regenerateBtn.disabled = false;
        regenerateBtn.textContent = 'Regenerate SSH keypair';
        resetRegenerateState();
      });
  }

  async function generateSslCert() {
    const btn = document.getElementById('generateSslBtn');
    const statusEl = document.getElementById('sslStatusMessage');
    const initialLabel = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Working...';

    try {
      const res = await fetch('/api/generate-ssl-cert', {
        method: 'POST',
        headers: { 'X-CSRF-Token': csrfToken }
      });
      const data = await res.json();
      if (data.success) {
        statusEl.className = 'status-message success';
        statusEl.textContent = 'SSL certificates generated successfully.';
      } else {
        statusEl.className = 'status-message error';
        statusEl.textContent = data.error || 'Failed to generate SSL certificates.';
      }
    } catch (error) {
      statusEl.className = 'status-message error';
      statusEl.textContent = 'Error: ' + error.message;
    }
    statusEl.style.display = 'block';
    btn.disabled = false;
    btn.textContent = initialLabel;
  }
</script>
{% endblock %}
