{% extends "_layout.html" %}
{% set page_title = "Power Management" %}
{% set page_subtitle = "Schedule reboots and control system power." %}
{% set active_page = "system_management" %}

{% block head_extra %}
<style>
  .field.no-border {
    border-bottom: none;
    padding-bottom: 0;
  }
</style>
{% endblock %}

{% block content %}
<div class="content-grid">
  <div class="card">
    <div class="card-title">Scheduled reboot</div>
    <div class="field">
      <div class="field-label">
        <strong>Enable automatic reboot</strong>
        <span class="field-hint">Run a daily reboot at the time below.</span>
      </div>
      <div class="field-control">
        <label class="toggle">
          <input type="checkbox" id="rebootEnabled" name="reboot_enabled"
            {% if config.get('reboot_enabled', False) %}checked{% endif %}>
          <span class="toggle-ui"></span>
        </label>
      </div>
    </div>
    <div class="field">
      <div class="field-label">
        <strong>Reboot time</strong>
        <span class="field-hint">Local time for automatic reboot.</span>
      </div>
      <div class="field-control">
        {% set rt = config.get('reboot_time', '12:00 AM').split(' ') %}
        {% set hm = rt[0].split(':') %}
        <select name="reboot_hour" id="reboot_hour">
          {% for h in range(1,13) %}
          <option value="{{ h }}" {% if hm[0]==h|string %}selected{% endif %}>{{ h }}</option>
          {% endfor %}
        </select>
        <span class="field-hint">:</span>
        <select name="reboot_minute" id="reboot_minute">
          {% for m in range(0,60) %}
          <option value="{{ '%02d' % m }}" {% if hm[1]==('%02d' % m) %}selected{% endif %}>{{ '%02d' % m }}</option>
          {% endfor %}
        </select>
        <select name="reboot_ampm" id="reboot_ampm">
          <option value="AM" {% if (rt|length>1 and rt[1]=='AM') %}selected{% endif %}>AM</option>
          <option value="PM" {% if (rt|length>1 and rt[1]=='PM') %}selected{% endif %}>PM</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Immediate actions</div>
    <div class="field no-border">
      <div class="field-label">
        <strong>System controls</strong>
        <span class="field-hint">Restart or power down the device.</span>
      </div>
      <div class="field-control">
        <button id="rebootBtn" class="button" type="button">Reboot</button>
        <button id="shutdownBtn" class="button button-danger" type="button">Shutdown</button>
      </div>
    </div>
    <div id="status" class="field-hint"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  const rebootBtn = document.getElementById('rebootBtn');
  const shutdownBtn = document.getElementById('shutdownBtn');
  const statusEl = document.getElementById('status');
  const rebootEnabled = document.getElementById('rebootEnabled');
  const rebootHour = document.getElementById('reboot_hour');
  const rebootMinute = document.getElementById('reboot_minute');
  const rebootAmpm = document.getElementById('reboot_ampm');

  async function postJson(url, data) {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
      body: JSON.stringify(data),
    });
    return res.json();
  }

  async function updateSchedule() {
    statusEl.textContent = 'Saving...';
    try {
      const data = await postJson('/api/reboot-config', {
        reboot_enabled: rebootEnabled.checked,
        reboot_hour: rebootHour.value,
        reboot_minute: rebootMinute.value,
        reboot_ampm: rebootAmpm.value,
      });
      if (data.status === 'saved') {
        statusEl.textContent = 'Schedule saved.';
      } else {
        statusEl.textContent = data.error || 'Failed to save schedule.';
      }
    } catch (err) {
      statusEl.textContent = 'Error saving schedule.';
    }
  }

  rebootEnabled.addEventListener('change', updateSchedule);
  rebootHour.addEventListener('change', updateSchedule);
  rebootMinute.addEventListener('change', updateSchedule);
  rebootAmpm.addEventListener('change', updateSchedule);

  rebootBtn.addEventListener('click', async () => {
    rebootBtn.disabled = true;
    statusEl.textContent = 'Rebooting...';
    try {
      await postJson('/api/reboot', {});
      statusEl.textContent = 'Reboot command sent.';
    } catch (err) {
      statusEl.textContent = 'Failed to reboot.';
    }
    rebootBtn.disabled = false;
  });

  shutdownBtn.addEventListener('click', async () => {
    shutdownBtn.disabled = true;
    statusEl.textContent = 'Shutting down...';
    try {
      await postJson('/api/shutdown', {});
      statusEl.textContent = 'Shutdown command sent.';
    } catch (err) {
      statusEl.textContent = 'Failed to shutdown.';
    }
    shutdownBtn.disabled = false;
  });
</script>
{% endblock %}
