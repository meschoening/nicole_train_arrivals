<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>System and Power Management - {{ display_name }}</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 24px;
    }

    .row {
      margin-bottom: 12px;
    }

    label {
      display: inline-block;
      min-width: 220px;
      font-weight: bold;
    }

    input[type="checkbox"] {
      transform: scale(1.3);
      margin-right: 8px;
    }

    select {
      padding: 6px;
      font-size: 14px;
    }

    button {
      padding: 12px 18px;
      font-weight: bold;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ddd;
      cursor: pointer;
      min-width: 200px;
    }

    button.normal {
      background: #f0f0f0;
      color: #000;
    }

    button.normal:hover {
      background: #e6e6e6;
    }

    button.confirm {
      background: #f44336;
      color: white;
      border: 1px solid #c62828;
    }

    button.confirm:hover {
      background: #d32f2f;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    a.btn {
      text-decoration: none;
      display: inline-block;
      padding: 8px 14px;
      border-radius: 6px;
      background: #f0f0f0;
      color: #000;
      font-weight: 700;
      border: 1px solid #ddd;
    }

    a.btn:hover {
      background: #e6e6e6;
    }

    .buttons-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 24px;
    }

    #status {
      margin-top: 16px;
      color: #666;
      font-weight: bold;
    }

    /* Reboot waiting overlay */
    #rebootOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    #rebootOverlay.visible {
      display: flex;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(255, 255, 255, 0.2);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 24px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #rebootOverlay .message {
      color: #fff;
      font-size: 18px;
      text-align: center;
      max-width: 300px;
    }

    #rebootOverlay .submessage {
      color: #aaa;
      font-size: 14px;
      margin-top: 12px;
      text-align: center;
    }

    #rebootOverlay .error-message {
      color: #ff6b6b;
      font-size: 16px;
      margin-top: 16px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="row">
      <a href="{{ url_for('index') }}" class="btn">‚Üê Back</a>
    </div>
    <h2>System and Power Management</h2>

    <div class="row">
      <label>Enable Automatic Reboot</label>
      <input type="checkbox" id="rebootEnabled" name="reboot_enabled" {% if config.get('reboot_enabled', False)
        %}checked{% endif %}>
    </div>

    <div class="row">
      <label>Reboot Time</label>
      {% set rt = config.get('reboot_time', '12:00 AM').split(' ') %}
      {% set hm = rt[0].split(':') %}
      <select name="reboot_hour" id="reboot_hour">
        {% for h in range(1,13) %}
        <option value="{{ h }}" {% if hm[0]==h|string %}selected{% endif %}>{{ h }}</option>
        {% endfor %}
      </select>
      :
      <select name="reboot_minute" id="reboot_minute">
        {% for m in range(0,60) %}
        <option value="{{ '%02d' % m }}" {% if hm[1]==('%02d' % m) %}selected{% endif %}>{{ '%02d' % m }}</option>
        {% endfor %}
      </select>
      <select name="reboot_ampm" id="reboot_ampm">
        <option value="AM" {% if (rt|length>1 and rt[1]=='AM') %}selected{% endif %}>AM</option>
        <option value="PM" {% if (rt|length>1 and rt[1]=='PM') %}selected{% endif %}>PM</option>
      </select>
    </div>

    <div class="buttons-container">
      <button id="rebootBtn" class="normal">Reboot</button>
      <button id="shutdownBtn" class="normal">Shutdown</button>
    </div>
    <div id="status" class="row"></div>
  </div>

  <!-- Reboot waiting overlay -->
  <div id="rebootOverlay">
    <div class="title" style="color: #fff; font-size: 24px; font-weight: bold; margin-bottom: 20px;">Reboot in
      progress...</div>
    <div class="spinner"></div>
    <div class="message">Waiting for system to come back online...</div>
    <div class="submessage">This may take up to 2 minutes</div>
    <div class="submessage">Will redirect to home page when complete.</div>
    <div id="rebootError" class="error-message" style="display: none;"></div>
  </div>

  <script>
    const rebootBtn = document.getElementById('rebootBtn');
    const shutdownBtn = document.getElementById('shutdownBtn');
    const statusEl = document.getElementById('status');
    const rebootEnabled = document.getElementById('rebootEnabled');
    const rebootHour = document.getElementById('reboot_hour');
    const rebootMinute = document.getElementById('reboot_minute');
    const rebootAmpm = document.getElementById('reboot_ampm');

    let rebootConfirmed = false;
    let shutdownConfirmed = false;

    function setStatus(text, color = '#666') {
      statusEl.textContent = text;
      statusEl.style.color = color;
    }

    function resetRebootButton() {
      rebootBtn.textContent = 'Reboot';
      rebootBtn.className = 'normal';
      rebootBtn.disabled = false;
      rebootConfirmed = false;
    }

    function resetShutdownButton() {
      shutdownBtn.textContent = 'Shutdown';
      shutdownBtn.className = 'normal';
      shutdownBtn.disabled = false;
      shutdownConfirmed = false;
    }

    function showRebootOverlay() {
      const overlay = document.getElementById('rebootOverlay');
      const errorEl = document.getElementById('rebootError');
      overlay.classList.add('visible');

      const homeUrl = '{{ url_for("index") }}';
      const pollInterval = 2000; // 2 seconds
      const maxWaitTime = 120000; // 120 seconds
      const startTime = Date.now();

      async function checkServerAvailable() {
        const elapsed = Date.now() - startTime;

        if (elapsed > maxWaitTime) {
          errorEl.textContent = 'Timeout: Server did not come back online within 2 minutes.';
          errorEl.style.display = 'block';
          return;
        }

        try {
          const response = await fetch(homeUrl, {
            method: 'HEAD',
            cache: 'no-store'
          });

          if (response.ok) {
            window.location.href = homeUrl;
            return;
          }
        } catch (e) {
          // Server not ready yet, continue polling
        }

        setTimeout(checkServerAvailable, pollInterval);
      }

      setTimeout(checkServerAvailable, 3000);
    }

    rebootBtn.addEventListener('click', async () => {
      if (!rebootConfirmed) {
        // First click: confirmation state
        rebootBtn.textContent = 'Click again to confirm reboot';
        rebootBtn.className = 'confirm';
        rebootConfirmed = true;
        setStatus('Click the button again to confirm reboot', '#d49200');

        // Reset after 5 seconds if not clicked again
        setTimeout(() => {
          if (rebootConfirmed) {
            resetRebootButton();
            setStatus('');
          }
        }, 5000);
      } else {
        // Second click: perform reboot
        rebootBtn.disabled = true;
        setStatus('Rebooting system...', '#d49200');
        try {
          await fetch('/api/reboot', { method: 'POST' });
        } catch (e) {
          // Expected - connection may drop immediately
        }
        showRebootOverlay();
      }
    });

    shutdownBtn.addEventListener('click', async () => {
      if (!shutdownConfirmed) {
        // First click: confirmation state
        shutdownBtn.textContent = 'Click again to confirm shutdown';
        shutdownBtn.className = 'confirm';
        shutdownConfirmed = true;
        setStatus('Click the button again to confirm shutdown', '#d49200');

        // Reset after 5 seconds if not clicked again
        setTimeout(() => {
          if (shutdownConfirmed) {
            resetShutdownButton();
            setStatus('');
          }
        }, 5000);
      } else {
        // Second click: perform shutdown
        shutdownBtn.disabled = true;
        setStatus('Shutting down system...', '#d49200');
        try {
          await fetch('/api/shutdown', { method: 'POST' });
          setStatus('System is shutting down... this page may become unreachable.', '#d49200');
        } catch (e) {
          setStatus('Failed to trigger shutdown.', '#cc3333');
          resetShutdownButton();
        }
      }
    });

    async function saveRebootConfig() {
      const enabled = rebootEnabled.checked;
      const hour = rebootHour.value;
      const minute = rebootMinute.value;
      const ampm = rebootAmpm.value;

      try {
        const response = await fetch('/api/reboot-config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            reboot_enabled: enabled,
            reboot_hour: hour,
            reboot_minute: minute,
            reboot_ampm: ampm
          })
        });

        if (response.ok) {
          setStatus('Reboot settings saved', '#4caf50');
          setTimeout(() => setStatus(''), 2000);
        } else {
          setStatus('Failed to save reboot settings', '#cc3333');
        }
      } catch (e) {
        setStatus('Failed to save reboot settings', '#cc3333');
      }
    }

    rebootEnabled.addEventListener('change', saveRebootConfig);
    rebootHour.addEventListener('change', saveRebootConfig);
    rebootMinute.addEventListener('change', saveRebootConfig);
    rebootAmpm.addEventListener('change', saveRebootConfig);
  </script>
</body>

</html>
