{% extends "_layout.html" %}
{% set page_title = "Software Update" %}
{% set page_subtitle = "Check, switch branches, and apply updates safely." %}
{% set active_page = "update" %}

{% block head_extra %}
<style>
  #console {
    background: #0b0f14;
    color: #e2e8f0;
    padding: 12px;
    border-radius: var(--radius-sm);
    min-height: 220px;
    white-space: pre-wrap;
    overflow: auto;
    font-family: var(--font-mono);
    font-size: 12px;
  }

  #successLabel {
    display: none;
    padding: 12px 16px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    margin-top: 8px;
    border: 1px solid rgba(31, 122, 93, 0.4);
    background: rgba(31, 122, 93, 0.12);
    color: var(--success);
  }

  #branchConfirmDialog {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.6);
    z-index: 9998;
    justify-content: center;
    align-items: center;
  }

  #branchConfirmDialog.visible {
    display: flex;
  }

  .confirm-dialog-content {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 20px;
    max-width: 460px;
  }

  .confirm-dialog-content h3 {
    margin-top: 0;
    color: var(--warning);
  }

  .confirm-dialog-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 16px;
  }
</style>
{% endblock %}

{% block content %}
<div class="content-grid">
  {% if update_available %}
  <div class="notice success">
    Update available. A new software update is ready to install.
  </div>
  {% endif %}

  <div class="card">
    <div class="card-title">Background update checks</div>
    <div class="field">
      <div class="field-label">
        <strong>Check interval</strong>
        <span class="field-hint">How often to check for updates (5-3600 seconds).</span>
      </div>
      <div class="field-control">
        <input class="input mono" type="number" id="checkInterval" min="5" max="3600" step="1"
          value="{{ update_check_interval }}">
        <button type="button" class="button" id="saveIntervalBtn">Save interval</button>
      </div>
    </div>
    <div class="field">
      <div class="field-label">
        <strong>Status</strong>
        <span class="field-hint">Updated on {{ last_saved }}</span>
      </div>
      <div class="field-control">
        <span id="lastSaved" class="field-hint">Last saved: {{ last_saved }}</span>
        <span id="intervalStatus" class="field-hint"></span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Update branch</div>
    <div class="field">
      <div class="field-label">
        <strong>Current branch</strong>
      </div>
      <div class="field-control">
        <span class="mono" id="currentBranchDisplay">{{ current_branch }}</span>
      </div>
    </div>
    <div class="field">
      <div class="field-label">
        <strong>Switch to</strong>
      </div>
      <div class="field-control">
        <select id="branchSelect">
          <option value="">Loading branches...</option>
        </select>
        <button type="button" class="button" id="switchBranchBtn" disabled>Switch branch</button>
      </div>
    </div>
    <div id="branchStatus" class="field-hint"></div>
  </div>

  <div class="card">
    <div class="card-title">Run update</div>
    <div class="field">
      <div class="field-label">
        <strong>Updater</strong>
        <span class="field-hint">Runs git pull and installs changes.</span>
      </div>
      <div class="field-control">
        <button id="runUpdate" class="button button-primary" type="button">Run update</button>
        <button id="rebootBtn" class="button" type="button" style="display: none;">Reboot system</button>
      </div>
    </div>
    <div id="status" class="field-hint"></div>
    <pre id="console"></pre>
    <div id="successLabel"></div>
  </div>
</div>

<div id="branchConfirmDialog">
  <div class="confirm-dialog-content">
    <h3>Confirm branch switch</h3>
    <p>
      You are about to switch from <strong id="confirmFromBranch">{{ current_branch }}</strong> to
      <strong id="confirmToBranch"></strong>.
    </p>
    <div class="notice warning">
      Switching branches may overwrite local changes.
    </div>
    <p>Continue with the switch?</p>
    <div class="confirm-dialog-buttons">
      <button type="button" class="button" id="cancelSwitchBtn">Cancel</button>
      <button type="button" class="button button-primary" id="confirmSwitchBtn">Confirm switch</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  const runBtn = document.getElementById('runUpdate');
  const rebootBtn = document.getElementById('rebootBtn');
  const consoleEl = document.getElementById('console');
  const statusEl = document.getElementById('status');
  const successLabelEl = document.getElementById('successLabel');

  let evtSource = null;
  const savedUpdateState = {{ update_state | tojson }};

  function clearConsole() { consoleEl.textContent = ''; }
  function appendLine(line) {
    consoleEl.textContent += (line.endsWith('\n') ? line : line + '\n');
    consoleEl.scrollTop = consoleEl.scrollHeight;
  }
  function setStatus(text, color = 'var(--text-muted)') { statusEl.textContent = text; statusEl.style.color = color; }
  function disableRun(disabled) { runBtn.disabled = disabled; }
  function showReboot(show) { rebootBtn.style.display = show ? 'inline-flex' : 'none'; }
  function showSuccessLabel(message) { successLabelEl.textContent = 'Installed Update: ' + message; successLabelEl.style.display = 'block'; }
  function hideSuccessLabel() { successLabelEl.style.display = 'none'; }

  function applySavedUpdateState(state) {
    if (!state || !state.reboot_required) {
      return;
    }
    if (state.console_output) {
      consoleEl.textContent = state.console_output;
      consoleEl.scrollTop = consoleEl.scrollHeight;
    }
    setStatus('Update completed. Reboot required.', 'var(--warning)');
    showReboot(true);
    if (state.commit_message) {
      showSuccessLabel(state.commit_message);
    } else {
      hideSuccessLabel();
    }
  }

  function closeEventSource() {
    if (evtSource) { evtSource.close(); evtSource = null; }
  }

  applySavedUpdateState(savedUpdateState);

  runBtn.addEventListener('click', () => {
    clearConsole();
    hideSuccessLabel();
    showReboot(false);
    setStatus('Running update...');
    disableRun(true);
    closeEventSource();

    evtSource = new EventSource('/api/update/run');
    evtSource.onmessage = (e) => {
      if (e && typeof e.data === 'string' && e.data.length) {
        appendLine(e.data);
      }
    };
    evtSource.addEventListener('done', (e) => {
      disableRun(false);
      try {
        const payload = JSON.parse(e.data || '{}');
        if (payload.has_error) {
          setStatus('Error updating. See console for details.', 'var(--danger)');
          showReboot(false);
        } else if (payload.has_updates) {
          setStatus('Update completed. Reboot required.', 'var(--warning)');
          showReboot(true);
          if (payload.commit_message) {
            showSuccessLabel(payload.commit_message);
          }
        } else {
          setStatus('Already up to date.', 'var(--success)');
          showReboot(false);
        }
      } catch {
        setStatus('Update finished.');
      }
      closeEventSource();
    });
    evtSource.onerror = () => {
      disableRun(false);
      setStatus('Connection error during update.', 'var(--danger)');
      closeEventSource();
    };
  });

  rebootBtn.addEventListener('click', async () => {
    setStatus('Rebooting system...');
    try {
      await fetch('/api/reboot', { method: 'POST', headers: { 'X-CSRF-Token': csrfToken } });
    } catch (e) {
    }
    if (window.startRebootOverlay) {
      window.startRebootOverlay();
    }
  });

  const saveIntervalBtn = document.getElementById('saveIntervalBtn');
  const checkIntervalInput = document.getElementById('checkInterval');
  const intervalStatusEl = document.getElementById('intervalStatus');
  const lastSavedEl = document.getElementById('lastSaved');

  function markUnsaved() {
    if (lastSavedEl) lastSavedEl.style.color = 'var(--danger)';
  }

  checkIntervalInput.addEventListener('input', markUnsaved);
  checkIntervalInput.addEventListener('change', markUnsaved);

  saveIntervalBtn.addEventListener('click', async () => {
    let interval = parseInt(checkIntervalInput.value, 10);

    if (isNaN(interval) || interval < 5) {
      interval = 5;
      checkIntervalInput.value = 5;
    } else if (interval > 3600) {
      interval = 3600;
      checkIntervalInput.value = 3600;
    }

    saveIntervalBtn.disabled = true;
    saveIntervalBtn.textContent = 'Saving...';

    try {
      const response = await fetch('/api/update-check-interval', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify({ interval: interval })
      });

      const data = await response.json();

      if (data.success) {
        intervalStatusEl.textContent = 'Saved! Update checks every ' + data.interval + ' seconds.';
        intervalStatusEl.style.color = 'var(--success)';
        const now = new Date();
        const timeStr = now.toLocaleString('en-US', {
          month: '2-digit',
          day: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        lastSavedEl.textContent = 'Last saved: ' + timeStr;
        lastSavedEl.style.color = 'var(--text-muted)';
      } else {
        intervalStatusEl.textContent = 'Error: ' + (data.error || 'Unknown error');
        intervalStatusEl.style.color = 'var(--danger)';
      }
    } catch (e) {
      intervalStatusEl.textContent = 'Error: ' + e.message;
      intervalStatusEl.style.color = 'var(--danger)';
    }

    saveIntervalBtn.disabled = false;
    saveIntervalBtn.textContent = 'Save interval';
  });

  const branchSelect = document.getElementById('branchSelect');
  const switchBranchBtn = document.getElementById('switchBranchBtn');
  const branchStatusEl = document.getElementById('branchStatus');
  const currentBranchDisplay = document.getElementById('currentBranchDisplay');
  const branchConfirmDialog = document.getElementById('branchConfirmDialog');
  const confirmFromBranch = document.getElementById('confirmFromBranch');
  const confirmToBranch = document.getElementById('confirmToBranch');
  const confirmSwitchBtn = document.getElementById('confirmSwitchBtn');
  const cancelSwitchBtn = document.getElementById('cancelSwitchBtn');

  let currentBranch = '{{ current_branch }}';
  let pendingBranch = null;

  async function loadBranches() {
    try {
      const response = await fetch('/api/git-branches');
      const data = await response.json();

      branchSelect.innerHTML = '';

      if (data.success && data.branches && data.branches.length > 0) {
        data.branches.forEach(branch => {
          const option = document.createElement('option');
          option.value = branch;
          option.textContent = branch;
          if (branch === currentBranch) {
            option.selected = true;
          }
          branchSelect.appendChild(option);
        });
        updateSwitchButton();
      } else {
        branchSelect.innerHTML = '<option value="">No branches found</option>';
      }
    } catch (e) {
      branchSelect.innerHTML = '<option value="">Error loading branches</option>';
      branchStatusEl.textContent = 'Error loading branches: ' + e.message;
      branchStatusEl.style.color = 'var(--danger)';
    }
  }

  function updateSwitchButton() {
    const selectedBranch = branchSelect.value;
    switchBranchBtn.disabled = !selectedBranch || selectedBranch === currentBranch;
  }

  branchSelect.addEventListener('change', updateSwitchButton);

  switchBranchBtn.addEventListener('click', () => {
    const selectedBranch = branchSelect.value;
    if (!selectedBranch || selectedBranch === currentBranch) return;

    pendingBranch = selectedBranch;
    confirmFromBranch.textContent = currentBranch;
    confirmToBranch.textContent = selectedBranch;
    branchConfirmDialog.classList.add('visible');
  });

  cancelSwitchBtn.addEventListener('click', () => {
    pendingBranch = null;
    branchConfirmDialog.classList.remove('visible');
  });

  confirmSwitchBtn.addEventListener('click', async () => {
    if (!pendingBranch) return;
    confirmSwitchBtn.disabled = true;
    confirmSwitchBtn.textContent = 'Switching...';
    branchStatusEl.textContent = 'Switching branches...';
    branchStatusEl.style.color = 'var(--text-muted)';

    try {
      const response = await fetch('/api/git-branch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify({ branch: pendingBranch })
      });
      const data = await response.json();
      if (data.success) {
        currentBranch = pendingBranch;
        currentBranchDisplay.textContent = pendingBranch;
        branchStatusEl.textContent = 'Branch switched to ' + pendingBranch + '.';
        branchStatusEl.style.color = 'var(--success)';
      } else {
        branchStatusEl.textContent = 'Error: ' + (data.error || 'Failed to switch branch.');
        branchStatusEl.style.color = 'var(--danger)';
      }
    } catch (e) {
      branchStatusEl.textContent = 'Error: ' + e.message;
      branchStatusEl.style.color = 'var(--danger)';
    }

    confirmSwitchBtn.disabled = false;
    confirmSwitchBtn.textContent = 'Confirm switch';
    branchConfirmDialog.classList.remove('visible');
    pendingBranch = null;
    updateSwitchButton();
  });

  loadBranches();
</script>
{% endblock %}
