<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Update Software</title>
    <style>
      body { font-family: sans-serif; margin: 0; padding: 0; }
      .container { max-width: 720px; margin: 0 auto; padding: 24px; }
      .row { margin-bottom: 12px; }
      button { padding: 8px 14px; font-weight: bold; }
      a.btn { text-decoration: none; display: inline-block; padding: 8px 14px; border-radius: 6px; background: #f0f0f0; color: #000; font-weight: 700; border: 1px solid #ddd; }
      a.btn:hover { background: #e6e6e6; }
      #console { background: #111; color: #ddd; padding: 12px; border-radius: 6px; min-height: 220px; white-space: pre-wrap; overflow: auto; }
      #status { margin-top: 8px; color: #666; }
      #restartBtn { display: none; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <a href="{{ url_for('index') }}" class="btn">‚Üê Back</a>
      </div>
      <h2>Update Software</h2>
      <div class="row">
        <button id="runUpdate">Run Update</button>
        <button id="restartBtn">Restart App</button>
      </div>
      <div id="status" class="row"></div>
      <pre id="console" class="row"></pre>
    </div>

    <script>
      const runBtn = document.getElementById('runUpdate');
      const restartBtn = document.getElementById('restartBtn');
      const consoleEl = document.getElementById('console');
      const statusEl = document.getElementById('status');

      let evtSource = null;

      function clearConsole() { consoleEl.textContent = ''; }
      function appendLine(line) { consoleEl.textContent += (line.endsWith('\n')? line : line + '\n'); consoleEl.scrollTop = consoleEl.scrollHeight; }
      function setStatus(text, color = '#666') { statusEl.textContent = text; statusEl.style.color = color; }
      function disableRun(disabled) { runBtn.disabled = disabled; }
      function showRestart(show) { restartBtn.style.display = show ? 'inline-block' : 'none'; }

      function closeEventSource() {
        if (evtSource) { evtSource.close(); evtSource = null; }
      }

      runBtn.addEventListener('click', () => {
        clearConsole();
        showRestart(false);
        setStatus('Running update...');
        disableRun(true);
        closeEventSource();

        evtSource = new EventSource('/api/update/run');
        evtSource.onmessage = (e) => {
          if (e && typeof e.data === 'string' && e.data.length) {
            appendLine(e.data);
          }
        };
        evtSource.addEventListener('done', (e) => {
          disableRun(false);
          try {
            const payload = JSON.parse(e.data || '{}');
            if (payload.has_error) {
              setStatus('Error updating. See console for details.', '#cc3333');
              showRestart(false);
            } else if (payload.has_updates) {
              setStatus('Update completed. Restart required.', '#d49200');
              showRestart(true);
            } else {
              setStatus('Already up to date.', '#2a7a2a');
              showRestart(false);
            }
          } catch {
            setStatus('Update finished.');
          }
          closeEventSource();
        });
        evtSource.onerror = () => {
          disableRun(false);
          setStatus('Connection error during update.', '#cc3333');
          closeEventSource();
        };
      });

      restartBtn.addEventListener('click', async () => {
        setStatus('Restarting app...');
        try {
          await fetch('/api/restart', { method: 'POST' });
          setStatus('App is restarting... this page may become unreachable.', '#d49200');
        } catch (e) {
          setStatus('Failed to trigger restart.', '#cc3333');
        }
      });
    </script>
  </body>
  </html>


