<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Change Font - {{ display_name }}</title>
    <style>
        /* Dynamic @font-face rules for each installed font */
        {% for font in fonts %}
        @font-face {
            font-family: '{{ font.name }}';
            src: url('/api/font-file/{{ font.name | urlencode }}') format('truetype');
            font-display: swap;
        }
        {% endfor %}

        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
            padding: 24px;
        }

        .row {
            margin-bottom: 12px;
        }

        a.btn {
            text-decoration: none;
            display: inline-block;
            padding: 8px 14px;
            border-radius: 6px;
            background: #f0f0f0;
            color: #000;
            font-weight: 700;
            border: 1px solid #ddd;
        }

        a.btn:hover {
            background: #e6e6e6;
        }

        .font-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .font-item {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .font-item:last-child {
            border-bottom: none;
        }

        .font-item:hover {
            background: #f9f9f9;
        }

        .font-item.selected {
            background: #e3f2fd;
        }

        .font-item input[type="radio"] {
            margin: 0;
            transform: scale(1.3);
        }

        .font-name {
            flex: 1;
        }

        .current-font {
            margin-bottom: 16px;
            padding: 12px 16px;
            background: #f5f5f5;
            border-radius: 6px;
        }

        .current-font label {
            font-weight: bold;
            margin-right: 8px;
        }

        .button-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 18px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        button.primary {
            background: #2196F3;
            color: white;
            border: none;
        }

        button.primary:hover {
            background: #1976D2;
        }

        button.primary:disabled {
            background: #90CAF9;
            cursor: not-allowed;
        }

        button.secondary {
            background: #f0f0f0;
            color: #000;
            border: 1px solid #ddd;
        }

        button.secondary:hover {
            background: #e6e6e6;
        }

        button.restart {
            background: #4CAF50;
            color: white;
            border: none;
        }

        button.restart:hover {
            background: #388E3C;
        }

        .status-message {
            margin-top: 12px;
            padding: 10px 14px;
            border-radius: 6px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #28a745;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #dc3545;
        }

        .upload-section {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #ddd;
        }

        .upload-section h3 {
            margin-bottom: 16px;
        }

        .file-input-wrapper {
            margin-bottom: 16px;
        }

        .file-input-wrapper input[type="file"] {
            display: block;
            width: 100%;
            padding: 12px;
            border: 2px dashed #ddd;
            border-radius: 6px;
            background: #fafafa;
            cursor: pointer;
            font-size: 14px;
        }

        .file-input-wrapper input[type="file"]:hover {
            border-color: #2196F3;
            background: #f5f9ff;
        }

        .file-input-wrapper input[type="file"]:focus {
            outline: none;
            border-color: #2196F3;
        }

        .upload-progress {
            margin-top: 12px;
            font-size: 14px;
            color: #666;
        }

        .upload-progress.error {
            color: #dc3545;
        }

        .upload-progress.success {
            color: #28a745;
        }

        {% include "_reboot_ui_styles.html" %}
    </style>
</head>

<body>
    <div class="container">
        {% include "_reboot_warning_bar.html" %}
        <div class="row">
            <a href="{{ url_for('index') }}" class="btn">‚Üê Back</a>
        </div>
        <h2>Change Display Font</h2>

        <div class="current-font">
            <label>Current Font:</label>
            <span id="currentFontDisplay" style="font-family: '{{ current_font }}';">{{ current_font }}</span>
        </div>

        <div class="font-list" id="fontList">
            {% for font in fonts %}
            <div class="font-item {% if font.name == current_font %}selected{% endif %}" data-font="{{ font.name }}">
                <input type="radio" name="font" value="{{ font.name }}" {% if font.name==current_font %}checked{% endif
                    %}>
                <span class="font-name" style="font-family: '{{ font.name }}';">{{ font.name }}</span>
            </div>
            {% endfor %}
        </div>

        <div class="button-row">
            <button type="button" id="applyBtn" class="primary" disabled>Apply Selected Font</button>
            <button type="button" id="revertBtn" class="secondary">Revert to Default ({{ default_font }})</button>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <div class="upload-section">
            <h2>Install New Font</h2>
            <div class="file-input-wrapper">
                <input type="file" id="fontFileInput" accept=".ttf,.otf">
            </div>
            <button type="button" id="uploadBtn" class="primary" disabled>Upload and Install Font</button>
            <div id="uploadProgress" class="upload-progress"></div>
        </div>
    </div>

    <script>
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const fontList = document.getElementById('fontList');
        const applyBtn = document.getElementById('applyBtn');
        const revertBtn = document.getElementById('revertBtn');
        const statusMessage = document.getElementById('statusMessage');
        const currentFontDisplay = document.getElementById('currentFontDisplay');

        let selectedFont = '{{ current_font }}';
        let savedFont = '{{ current_font }}';
        let pendingRestart = false;

        // Handle font item clicks
        fontList.addEventListener('click', (e) => {
            const item = e.target.closest('.font-item');
            if (!item) return;

            // Update selection
            document.querySelectorAll('.font-item').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
            item.querySelector('input[type="radio"]').checked = true;

            selectedFont = item.dataset.font;
            updateApplyButton();
        });

        function updateApplyButton() {
            if (pendingRestart) {
                applyBtn.textContent = 'Restart App';
                applyBtn.classList.remove('primary');
                applyBtn.classList.add('restart');
                applyBtn.disabled = false;
            } else {
                applyBtn.textContent = 'Apply Selected Font';
                applyBtn.classList.remove('restart');
                applyBtn.classList.add('primary');
                applyBtn.disabled = selectedFont === savedFont;
            }
        }

        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message ' + (isError ? 'error' : 'success');
            statusMessage.style.display = 'block';
        }

        function hideStatus() {
            statusMessage.style.display = 'none';
        }

        applyBtn.addEventListener('click', async () => {
            if (pendingRestart) {
                // Restart the app
                applyBtn.disabled = true;
                applyBtn.textContent = 'Restarting...';
                try {
                    const res = await fetch('/api/restart-app', { method: 'POST', headers: { 'X-CSRF-Token': csrfToken } });
                    const data = await res.json();
                    if (data.success) {
                        showStatus('Restarting application... Page will reload when ready.');
                        // Start polling for server to come back online
                        waitForServerAndReload();
                    } else {
                        showStatus(data.error || 'Failed to restart', true);
                        applyBtn.disabled = false;
                        updateApplyButton();
                    }
                } catch (err) {
                    // Connection error likely means server is restarting - start polling
                    showStatus('Restarting application... Page will reload when ready.');
                    waitForServerAndReload();
                }
                return;
            }

            // Apply font
            applyBtn.disabled = true;
            hideStatus();

            try {
                const res = await fetch('/api/font', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                    body: JSON.stringify({ font_family: selectedFont })
                });
                const data = await res.json();

                if (data.success) {
                    savedFont = selectedFont;
                    currentFontDisplay.textContent = selectedFont;
                    currentFontDisplay.style.fontFamily = `'${selectedFont}'`;
                    pendingRestart = true;
                    updateApplyButton();
                    showStatus('Font changed! Click "Restart App" to apply changes.');
                } else {
                    showStatus(data.error || 'Failed to save font', true);
                    applyBtn.disabled = false;
                }
            } catch (err) {
                showStatus('Error: ' + err.message, true);
                applyBtn.disabled = false;
            }
        });

        function waitForServerAndReload() {
            const checkInterval = 500; // ms
            const maxWait = 30000; // 30 seconds max
            let elapsed = 0;

            const pollServer = () => {
                fetch('/change-font', { method: 'HEAD' })
                    .then(response => {
                        if (response.ok) {
                            // Server is back, reload the page
                            window.location.reload();
                        } else {
                            scheduleNextPoll();
                        }
                    })
                    .catch(() => {
                        scheduleNextPoll();
                    });
            };

            const scheduleNextPoll = () => {
                elapsed += checkInterval;
                if (elapsed < maxWait) {
                    setTimeout(pollServer, checkInterval);
                } else {
                    showStatus('Server did not respond. Please reload the page manually.', true);
                    applyBtn.disabled = false;
                    updateApplyButton();
                }
            };

            // Start polling after a short delay to allow server to shut down
            setTimeout(pollServer, 1000);
        }

        revertBtn.addEventListener('click', async () => {
            revertBtn.disabled = true;
            hideStatus();

            try {
                const res = await fetch('/api/font/revert', { method: 'POST', headers: { 'X-CSRF-Token': csrfToken } });
                const data = await res.json();

                if (data.success) {
                    savedFont = data.font_family;
                    selectedFont = data.font_family;
                    currentFontDisplay.textContent = data.font_family;
                    currentFontDisplay.style.fontFamily = `'${data.font_family}'`;

                    // Update selection in list
                    document.querySelectorAll('.font-item').forEach(el => {
                        if (el.dataset.font === data.font_family) {
                            el.classList.add('selected');
                            el.querySelector('input[type="radio"]').checked = true;
                        } else {
                            el.classList.remove('selected');
                            el.querySelector('input[type="radio"]').checked = false;
                        }
                    });

                    pendingRestart = true;
                    updateApplyButton();
                    showStatus('Font reverted to default! Click "Restart App" to apply changes.');
                } else {
                    showStatus(data.error || 'Failed to revert font', true);
                }
            } catch (err) {
                showStatus('Error: ' + err.message, true);
            }

            revertBtn.disabled = false;
        });

        // Initial state
        updateApplyButton();

        // Font upload functionality
        const fontFileInput = document.getElementById('fontFileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadProgress = document.getElementById('uploadProgress');

        fontFileInput.addEventListener('change', () => {
            const hasFile = fontFileInput.files && fontFileInput.files.length > 0;
            uploadBtn.disabled = !hasFile;
            uploadProgress.textContent = '';
            uploadProgress.className = 'upload-progress';
        });

        function showUploadProgress(message, isError = false, isSuccess = false) {
            uploadProgress.textContent = message;
            uploadProgress.className = 'upload-progress';
            if (isError) {
                uploadProgress.classList.add('error');
            } else if (isSuccess) {
                uploadProgress.classList.add('success');
            }
        }

        uploadBtn.addEventListener('click', () => {
            const file = fontFileInput.files && fontFileInput.files[0];
            if (!file) {
                showUploadProgress('Please select a font file first.', true);
                return;
            }

            // Validate file extension client-side
            const ext = file.name.toLowerCase().split('.').pop();
            if (ext !== 'ttf' && ext !== 'otf') {
                showUploadProgress('Error: Only .ttf and .otf files are supported.', true);
                return;
            }

            // Validate file size client-side (10MB max)
            if (file.size > 10 * 1024 * 1024) {
                showUploadProgress('Error: File too large (max 10MB).', true);
                return;
            }

            // Disable button and show installing state
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Installing...';
            showUploadProgress('Uploading... 0%');

            const formData = new FormData();
            formData.append('font_file', file);

            const xhr = new XMLHttpRequest();

            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    if (percentComplete < 100) {
                        showUploadProgress(`Uploading... ${percentComplete}%`);
                    } else {
                        showUploadProgress('Installing font...');
                    }
                }
            });

            xhr.addEventListener('load', () => {
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (xhr.status === 200 && response.success) {
                        showUploadProgress(`Success! Font "${response.font_name}" installed. Refreshing page...`, false, true);
                        // Reload the page to show the new font in the list
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        showUploadProgress(`Error: ${response.error || 'Upload failed'}`, true);
                        resetUploadButton();
                    }
                } catch (e) {
                    showUploadProgress('Error: Invalid server response', true);
                    resetUploadButton();
                }
            });

            xhr.addEventListener('error', () => {
                showUploadProgress('Error: Network error occurred', true);
                resetUploadButton();
            });

            xhr.addEventListener('abort', () => {
                showUploadProgress('Upload cancelled', true);
                resetUploadButton();
            });

            xhr.open('POST', '/api/font/upload');
            xhr.setRequestHeader('X-CSRF-Token', csrfToken);
            xhr.send(formData);
        });

        function resetUploadButton() {
            uploadBtn.disabled = !(fontFileInput.files && fontFileInput.files.length > 0);
            uploadBtn.textContent = 'Upload and Install Font';
        }
    </script>
    {% include "_reboot_overlay.html" %}
    {% include "_reboot_ui_script.html" %}
</body>

</html>
